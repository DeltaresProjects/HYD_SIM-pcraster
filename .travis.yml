language: cpp

sudo: true

os:
    - linux
    # - osx

compiler:
    # - clang
    - gcc

env:
    - TRAVIS_BUILD_TYPE=Debug TRAVIS_CMAKE_GENERATOR="Unix Makefiles"
    # TODO build is taking too long, split even more, see script section
    # - TRAVIS_BUILD_TYPE=Release TRAVIS_CMAKE_GENERATOR="Unix Makefiles"

# matrix:
#     - exclude:
#         - os: osx
#           compiler: gcc
#     - allow_failures:
#         - os: osx
#         - compiler: clang

addons:
    apt:
        sources:
            - boost-latest
            # - llvm-toolchain-precise-3.5
            - ubuntu-toolchain-r-test
        packages:
            # - clang-3.5
            - doxygen
            - g++-4.9
            - imagemagick
            - libgeos++-dev
            - libboost1.55-all-dev
            - libxml2-dev
            - libxslt1-dev
            - python-dev
            - python-gdal
            - python-numpy
            - python-virtualenv
            - xsltproc
            - graphviz
            # - libc++-dev
            # - gdal-bin # 02/2016 travis vm currently installs v1.x
            - libgdal-dev

before_install:
    - sudo add-apt-repository ppa:beineri/opt-qt487 -y
    - sudo apt-get update -qq

    # Update CMake.
    - wget --no-check-certificate http://www.cmake.org/files/v3.2/cmake-3.2.3-Linux-x86_64.tar.gz

    # We need to patch xsd because of:
    # http://www.codesynthesis.com/pipermail/xsd-users/2014-February/004196.html
    - wget --no-check-certificate http://www.codesynthesis.com/download/xsd/3.3/linux-gnu/x86_64/xsd-3.3.0-x86_64-linux-gnu.tar.bz2
    - wget --no-check-certificate http://codesynthesis.com/~boris/tmp/xsd/xsd-3.3.0-gcc-4.7-clang.patch
    - if [ "$CC" = "clang" ]; then export CC="clang-3.5" CXX="clang++-3.5"; fi
    - if [ "$CC" = "gcc" ]; then export CC="gcc-4.9" CXX="g++-4.9"; fi

    # Travis doesn't have
    # - PCRaster's raster format library
    # - Qwt library
    # We build and install those ourselves using Peacock.
    - git clone --recursive https://github.com/geoneric/peacock.git

install:
    - set -e

    - cd $TRAVIS_BUILD_DIR
    - sudo pip install --upgrade pip
    - sudo pip install --upgrade docopt
    - sudo pip install --upgrade sphinx
    - sudo pip install pillow

    - sudo apt-get install opt-qt4-qmake opt-qt4-dev-tools
    - export PATH=/opt/qt-4.8/bin:$PATH
    - cat /opt/qt-4.8/bin/qt-4.8-env.sh

    - mkdir $TRAVIS_BUILD_DIR/local

    - cd $TRAVIS_BUILD_DIR/local
    - tar zxf ../cmake-3.2.3-Linux-x86_64.tar.gz
    - export PATH=$TRAVIS_BUILD_DIR/local/cmake-3.2.3-Linux-x86_64/bin:$PATH

    - cd $TRAVIS_BUILD_DIR/local
    - tar jxf ../xsd-3.3.0-x86_64-linux-gnu.tar.bz2
    - cd xsd-3.3.0-x86_64-linux-gnu
    - patch -p1 < ../../xsd-3.3.0-gcc-4.7-clang.patch
    - export PATH=$TRAVIS_BUILD_DIR/local/xsd-3.3.0-x86_64-linux-gnu/bin:$PATH

    - cd $TRAVIS_BUILD_DIR/peacock
    - mkdir build
    - cd build
    - cmake -G"${TRAVIS_CMAKE_GENERATOR}" -Dpeacock_prefix=$TRAVIS_BUILD_DIR/local -Dbuild_pcraster_raster_format=true -Dpcraster_raster_format_version=1.3.1 -Dbuild_qwt=true -Dqwt_version=6.1.2 -Dbuild_gdal=true -Dgdal_version=2.0.1 -Dbuild_fern=true -Dfern_git_repository=https://github.com/geoneric/fern.git -Dfern_git_tag=12fa63cb2d72e6abafbbac50f40ca2143344da6a -Dfern_build_fern_algorithm=true -Dfern_build_fern_documentation=true -Dfern_build_fern_test=true ..
    - cmake --build . --target all

before_script:
    - mkdir $TRAVIS_BUILD_DIR/build
    - cd $TRAVIS_BUILD_DIR/build
    - cmake -G"${TRAVIS_CMAKE_GENERATOR}" -DPEACOCK_PREFIX:PATH=$TRAVIS_BUILD_DIR/local -DCMAKE_BUILD_TYPE=${TRAVIS_BUILD_TYPE} -DPCRASTER_BUILD_EXPERIMENTAL:BOOL=TRUE -DPCRASTER_BUILD_TEST:BOOL=TRUE ..

script:
    - set -e  # Don't run the tests if the build fails.
    - cd $TRAVIS_BUILD_DIR/build

    # Split the build, 'make all' takes > 50 minutes, which is not allowed.
    - cmake --build . --config ${TRAVIS_BUILD_TYPE} --target pcraster_aguila
    - cmake --build . --config ${TRAVIS_BUILD_TYPE} --target mapattr
    - cmake --build . --config ${TRAVIS_BUILD_TYPE} --target oldcalc
    - cmake --build . --config ${TRAVIS_BUILD_TYPE} --target pcrcalc
    - cmake --build . --config ${TRAVIS_BUILD_TYPE} --target _pcraster_multicore
    - cmake --build . --config ${TRAVIS_BUILD_TYPE} --target all

    # own GDAL 2.x library needs to be found to execute unit tests
    - export LD_LIBRARY_PATH=$TRAVIS_BUILD_DIR/local/linux/linux/gcc-4/x86_64/lib

    - cmake --build . --config ${TRAVIS_BUILD_TYPE} --target test
    - cd ..

notifications:
    email:
        - k.dejong1@uu.nl
        - o.schmitz@uu.nl
