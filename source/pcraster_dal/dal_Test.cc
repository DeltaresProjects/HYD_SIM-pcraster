#define BOOST_TEST_MODULE dal test suite
#ifndef INCLUDED_BOOST_TEST_INCLUDED_UNIT_TEST
#include <boost/test/included/unit_test.hpp>
#define INCLUDED_BOOST_TEST_INCLUDED_UNIT_TEST
#endif

#ifndef INCLUDED_QCOREAPPLICATION
#include <QCoreApplication>
#define INCLUDED_QCOREAPPLICATION
#endif

#ifndef INCLUDED_DEV_FILESYSTEMUTILS
#include "dev_FilesystemUtils.h"
#define INCLUDED_DEV_FILESYSTEMUTILS
#endif

#ifndef INCLUDED_DEV_GDALCLIENT
#include "dev_GDalClient.h"
#define INCLUDED_DEV_GDALCLIENT
#endif

#ifndef INCLUDED_DEV_QTCLIENT
#include "dev_QtClient.h"
#define INCLUDED_DEV_QTCLIENT
#endif

#ifndef INCLUDED_DAL_ARRAYTEST
#include "dal_ArrayTest.h"
#define INCLUDED_DAL_ARRAYTEST
#endif

#ifndef INCLUDED_DAL_BINARYTABLEDRIVERTEST
#include "dal_BinaryTableDriverTest.h"
#define INCLUDED_DAL_BINARYTABLEDRIVERTEST
#endif

#ifndef INCLUDED_DAL_CLIENT
#include "dal_Client.h"
#define INCLUDED_DAL_CLIENT
#endif

#ifndef INCLUDED_DAL_CLIENTTEST
#include "dal_ClientTest.h"
#define INCLUDED_DAL_CLIENTTEST
#endif

#ifndef INCLUDED_DAL_CONFIGURE
#include "dal_Configure.h"
#define INCLUDED_DAL_CONFIGURE
#endif

#ifndef INCLUDED_DAL_COORDINATEMAPPERTEST
#include "dal_CoordinateMapperTest.h"
#define INCLUDED_DAL_COORDINATEMAPPERTEST
#endif

#ifndef INCLUDED_DAL_CONNECTIONINFOTEST
#include "dal_ConnectionInfoTest.h"
#define INCLUDED_DAL_CONNECTIONINFOTEST
#endif

#ifndef INCLUDED_DAL_CSFMAPTEST
#include "dal_CSFMapTest.h"
#define INCLUDED_DAL_CSFMAPTEST
#endif

#ifndef INCLUDED_DAL_CSFRASTERDRIVERTEST
#include "dal_CSFRasterDriverTest.h"
#define INCLUDED_DAL_CSFRASTERDRIVERTEST
#endif

#ifndef INCLUDED_DAL_DATASPACETEST
#include "dal_DataSpaceTest.h"
#define INCLUDED_DAL_DATASPACETEST
#endif

#ifndef INCLUDED_DAL_DATASPACEADDRESSTEST
#include "dal_DataSpaceAddressTest.h"
#define INCLUDED_DAL_DATASPACEADDRESSTEST
#endif

#ifndef INCLUDED_DAL_DATASPACEADDRESSMAPPERTEST
#include "dal_DataSpaceAddressMapperTest.h"
#define INCLUDED_DAL_DATASPACEADDRESSMAPPERTEST
#endif

#ifndef INCLUDED_DAL_DATASPACEITERATORTEST
#include "dal_DataSpaceIteratorTest.h"
#define INCLUDED_DAL_DATASPACEITERATORTEST
#endif

#ifndef INCLUDED_DAL_DALTEST
#include "dal_DalTest.h"
#define INCLUDED_DAL_DALTEST
#endif

#ifndef INCLUDED_DAL_DATASOURCETEST
#include "dal_DataSourceTest.h"
#define INCLUDED_DAL_DATASOURCETEST
#endif

#ifndef INCLUDED_DAL_DEFTEST
#include "dal_DefTest.h"
#define INCLUDED_DAL_DEFTEST
#endif

#ifndef INCLUDED_DAL_DIMENSIONTEST
#include "dal_DimensionTest.h"
#define INCLUDED_DAL_DIMENSIONTEST
#endif

#ifndef INCLUDED_DAL_ENVIRONMENTTEST
#include "dal_EnvironmentTest.h"
#define INCLUDED_DAL_ENVIRONMENTTEST
#endif

#ifndef INCLUDED_DAL_FEATURELAYERTEST
#include "dal_FeatureLayerTest.h"
#define INCLUDED_DAL_FEATURELAYERTEST
#endif

#ifndef INCLUDED_DAL_FEATUREPATHTEST
#include "dal_FeaturePathTest.h"
#define INCLUDED_DAL_FEATUREPATHTEST
#endif

#ifndef INCLUDED_DAL_FILESYSTEMUTILSTEST
#include "dal_FilesystemUtilsTest.h"
#define INCLUDED_DAL_FILESYSTEMUTILSTEST
#endif

#ifndef INCLUDED_DAL_GDALRASTERDRIVERTEST
#include "dal_GDALRasterDriverTest.h"
#define INCLUDED_DAL_GDALRASTERDRIVERTEST
#endif

#ifndef INCLUDED_DAL_GEOEASTABLEDRIVERTEST
#include "dal_GeoEASTableDriverTest.h"
#define INCLUDED_DAL_GEOEASTABLEDRIVERTEST
#endif

#ifndef INCLUDED_DAL_LIBRARY
#include "dal_Library.h"
#define INCLUDED_DAL_LIBRARY
#endif

#ifndef INCLUDED_DAL_MAPPERUTILSTEST
#include "dal_MapperUtilsTest.h"
#define INCLUDED_DAL_MAPPERUTILSTEST
#endif

#ifndef INCLUDED_DAL_MATHUTILSTEST
#include "dal_MathUtilsTest.h"
#define INCLUDED_DAL_MATHUTILSTEST
#endif

#ifndef INCLUDED_DAL_MATRIXDIMENSIONSTEST
#include "dal_MatrixDimensionsTest.h"
#define INCLUDED_DAL_MATRIXDIMENSIONSTEST
#endif

#ifndef INCLUDED_DAL_MATRIXDRIVERTEST
#include "dal_MatrixDriverTest.h"
#define INCLUDED_DAL_MATRIXDRIVERTEST
#endif

#ifndef INCLUDED_DAL_MATRIXTEST
#include "dal_MatrixTest.h"
#define INCLUDED_DAL_MATRIXTEST
#endif

#ifndef INCLUDED_DAL_MEMORYDATAPOOLTEST
#include "dal_MemoryDataPoolTest.h"
#define INCLUDED_DAL_MEMORYDATAPOOLTEST
#endif

#ifndef INCLUDED_DAL_MEMORYRASTERDATATEST
#include "dal_MemoryRasterDataTest.h"
#define INCLUDED_DAL_MEMORYRASTERDATATEST
#endif

#ifndef INCLUDED_DAL_MEMORYRASTERDRIVERTEST
#include "dal_MemoryRasterDriverTest.h"
#define INCLUDED_DAL_MEMORYRASTERDRIVERTEST
#endif

#ifndef INCLUDED_DAL_MEMORYTABLEDATATEST
#include "dal_MemoryTableDataTest.h"
#define INCLUDED_DAL_MEMORYTABLEDATATEST
#endif

#ifndef INCLUDED_DAL_MEMORYTABLEDRIVERTEST
#include "dal_MemoryTableDriverTest.h"
#define INCLUDED_DAL_MEMORYTABLEDRIVERTEST
#endif

#ifndef INCLUDED_DAL_OGRFEATUREDRIVERTEST
#include "dal_OgrFeatureDriverTest.h"
#define INCLUDED_DAL_OGRFEATUREDRIVERTEST
#endif

#ifndef INCLUDED_DAL_PCRBLOCKDRIVERTEST
#include "dal_PCRBlockDriverTest.h"
#define INCLUDED_DAL_PCRBLOCKDRIVERTEST
#endif

#ifndef INCLUDED_DAL_PROPERTIESTEST
#include "dal_PropertiesTest.h"
#define INCLUDED_DAL_PROPERTIESTEST
#endif

#ifndef INCLUDED_DAL_RASTERDALTEST
#include "dal_RasterDalTest.h"
#define INCLUDED_DAL_RASTERDALTEST
#endif

#ifndef INCLUDED_DAL_RASTERDIMENSIONSTEST
#include "dal_RasterDimensionsTest.h"
#define INCLUDED_DAL_RASTERDIMENSIONSTEST
#endif

#ifndef INCLUDED_DAL_REGULAREXPRESSIONSTEST
#include "dal_RegularExpressionsTest.h"
#define INCLUDED_DAL_REGULAREXPRESSIONSTEST
#endif

#ifndef INCLUDED_DAL_SPACESTEPMAPPERTEST
#include "dal_SpaceStepMapperTest.h"
#define INCLUDED_DAL_SPACESTEPMAPPERTEST
#endif

#ifndef INCLUDED_DAL_SPACESTEPCOORDINATEMAPPERTEST
#include "dal_SpaceStepCoordinateMapperTest.h"
#define INCLUDED_DAL_SPACESTEPCOORDINATEMAPPERTEST
#endif

#ifndef INCLUDED_DAL_SPATIALCOORDINATETEST
#include "dal_SpatialCoordinateTest.h"
#define INCLUDED_DAL_SPATIALCOORDINATETEST
#endif

#ifndef INCLUDED_DAL_SQLTABLEDRIVERTEST
#include "dal_SQLTableDriverTest.h"
#define INCLUDED_DAL_SQLTABLEDRIVERTEST
#endif

#ifndef INCLUDED_DAL_STACKINFOTEST
#include "dal_StackInfoTest.h"
#define INCLUDED_DAL_STACKINFOTEST
#endif

#ifndef INCLUDED_DAL_STEPCOORDINATEMAPPERTEST
#include "dal_StepCoordinateMapperTest.h"
#define INCLUDED_DAL_STEPCOORDINATEMAPPERTEST
#endif

#ifndef INCLUDED_DAL_STEPMAPPERTEST
#include "dal_StepMapperTest.h"
#define INCLUDED_DAL_STEPMAPPERTEST
#endif

#ifndef INCLUDED_DAL_TABLEDALTEST
#include "dal_TableDalTest.h"
#define INCLUDED_DAL_TABLEDALTEST
#endif

#ifndef INCLUDED_DAL_TABLETEST
#include "dal_TableTest.h"
#define INCLUDED_DAL_TABLETEST
#endif

#ifndef INCLUDED_DAL_TABLEDRIVERTEST
#include "dal_TableDriverTest.h"
#define INCLUDED_DAL_TABLEDRIVERTEST
#endif

#ifndef INCLUDED_DAL_TEXTCONSTANTDRIVERTEST
#include "dal_TextConstantDriverTest.h"
#define INCLUDED_DAL_TEXTCONSTANTDRIVERTEST
#endif

#ifndef INCLUDED_DAL_TEXTFILEDRIVERTEST
#include "dal_TextFileDriverTest.h"
#define INCLUDED_DAL_TEXTFILEDRIVERTEST
#endif

#ifndef INCLUDED_DAL_TEXTMATRIXDRIVERTEST
#include "dal_TextMatrixDriverTest.h"
#define INCLUDED_DAL_TEXTMATRIXDRIVERTEST
#endif

#ifndef INCLUDED_DAL_TEXTTABLEDRIVERTEST
#include "dal_TextTableDriverTest.h"
#define INCLUDED_DAL_TEXTTABLEDRIVERTEST
#endif

#ifndef INCLUDED_DAL_TIMESTEPCOORDINATEMAPPERTEST
#include "dal_TimeStepCoordinateMapperTest.h"
#define INCLUDED_DAL_TIMESTEPCOORDINATEMAPPERTEST
#endif

#ifndef INCLUDED_DAL_TIMESTEPMAPPERTEST
#include "dal_TimeStepMapperTest.h"
#define INCLUDED_DAL_TIMESTEPMAPPERTEST
#endif

#ifndef INCLUDED_DAL_TYPETEST
#include "dal_TypeTest.h"
#define INCLUDED_DAL_TYPETEST
#endif

#ifndef INCLUDED_DAL_TYPESTEST
#include "dal_TypesTest.h"
#define INCLUDED_DAL_TYPESTEST
#endif

#ifndef INCLUDED_DAL_USECASESTEST
#include "dal_UseCasesTest.h"
#define INCLUDED_DAL_USECASESTEST
#endif

#ifndef INCLUDED_DAL_UTILSTEST
#include "dal_UtilsTest.h"
#define INCLUDED_DAL_UTILSTEST
#endif

#ifndef INCLUDED_DAL_VECTORDRIVERTEST
#include "dal_VectorDriverTest.h"
#define INCLUDED_DAL_VECTORDRIVERTEST
#endif

#ifndef INCLUDED_DAL_VTKBLOCKDRIVERTEST
#include "dal_VTKBlockDriverTest.h"
#define INCLUDED_DAL_VTKBLOCKDRIVERTEST
#endif



namespace {
  static int argc = 1;
  static char const* argv[1] = { "/my/path/dalTest" };

// There is an interaction between the Boost Unit.Test framework and Qt which
// results in a crash in the destructor of QCoreApplication. It is not
// reproducable in other contexts.
// Workaround is to not use the TestSuite class as a vehicle to create and
// destruct the QtClient class, but some other class and a static global
// variable.
// Important thing for the test code is that QtClient's constructor is run.
// For the memory leakage checks it is relevant that the global variable is
// destructed (which isn't right now).
struct QtClientHack: public dev::QtClient<QCoreApplication>
{
  QtClientHack(
       int& argc,
       char** argv)
    : dev::QtClient<QCoreApplication>(argc, argv)
  {
    assert(dev::QtClient<QCoreApplication>::isInitialized());
  }
};

// This won't work either...
// static QtClientHack qtClientHack(argc, const_cast<char**>(argv));

// This won't work either...
// static boost::shared_ptr<QtClientHack> qtClientHack(new QtClientHack(argc,
//          const_cast<char**>(argv)));

// Let it dangle for now...
static QtClientHack* qtClientHack(new QtClientHack(argc,
         const_cast<char**>(argv)));

}



boost::unit_test::test_suite* init_unit_test_suite(
         int /* argc */,
         char** const /* argv[] */) {

  struct TestSuite: public boost::unit_test::test_suite,
                    public dev::GDalClient,
                    // public dev::QtClient<QCoreApplication> // ,
                    public dal::Client
  {
    TestSuite(
         int& /* argc */,
         char** argv)
      : boost::unit_test::test_suite("Master test suite"),
        dev::GDalClient(),
        // dev::QtClient<QCoreApplication>(argc, argv) // ,
        dal::Client(dev::prefix(argv[0]), true)
    {
      assert(dev::GDalClient::isInitialized());
      // assert(dev::QtClient<QCoreApplication>::isInitialized());
      assert(dal::Client::isInitialized());
    }
  };

  TestSuite* test = new TestSuite(::argc, const_cast<char**>(::argv));

  test->add(dal::EnvironmentTest::suite());
  test->add(dal::ClientTest::suite());
  test->add(dal::DefTest::suite());

  // Basics.
  test->add(dal::RegularExpressionsTest::suite());
  test->add(dal::ArrayTest::suite());
  test->add(dal::TypeTest::suite());
  test->add(dal::TypesTest::suite());
  test->add(dal::ConnectionInfoTest::suite());
  test->add(dal::StackInfoTest::suite());
  test->add(dal::FeaturePathTest::suite());

  test->add(dal::MathUtilsTest::suite());
  test->add(dal::FilesystemUtilsTest::suite());

  test->add(dal::SpatialCoordinateTest::suite());
  test->add(dal::DimensionTest::suite());
  test->add(dal::DataSpaceTest::suite());
  test->add(dal::DataSpaceAddressTest::suite());
  test->add(dal::DataSpaceIteratorTest::suite());

  test->add(dal::PropertiesTest::suite());

  test->add(dal::MatrixDimensionsTest::suite());
  test->add(dal::RasterDimensionsTest::suite());
  test->add(dal::MatrixTest::suite());
  test->add(dal::TableTest::suite());
  test->add(dal::FeatureLayerTest::suite());
  test->add(dal::StepMapperTest::suite());
  test->add(dal::SpaceStepMapperTest::suite());
  test->add(dal::TimeStepMapperTest::suite());
  test->add(dal::CoordinateMapperTest::suite());
  /// TODO test->add(dal::StepCoordinateMapperTest::suite());
  /// TODO test->add(dal::SpaceStepCoordinateMapperTest::suite());
  test->add(dal::TimeStepCoordinateMapperTest::suite());
  /// TODO test->add(dal::DataSpaceAddressMapperTest::suite());
  /// TODO test->add(dal::MapperUtilsTest::suite());

  // Drivers which make use of the stuff tested above.
  test->add(dal::UtilsTest::suite());
  test->add(dal::TableDriverTest::suite());
  test->add(dal::TextConstantDriverTest::suite());
  test->add(dal::TextFileDriverTest::suite());
  test->add(dal::TextTableDriverTest::suite());
  test->add(dal::GeoEASTableDriverTest::suite());
  test->add(dal::MatrixDriverTest::suite());
  test->add(dal::TextMatrixDriverTest::suite());
  test->add(dal::BinaryTableDriverTest::suite());
  test->add(dal::CSFMapTest::suite());
  test->add(dal::CSFRasterDriverTest::suite());
  test->add(dal::GDALRasterDriverTest::suite());
  /// TODO test->add(dal::SQLTableDriverTest::suite());
  test->add(dal::OgrFeatureDriverTest::suite());
  test->add(dal::PCRBlockDriverTest::suite());
  test->add(dal::VTKBlockDriverTest::suite());
  test->add(dal::VectorDriverTest::suite());

  // Dal which makes use of drivers tested above.
  test->add(dal::DalTest::suite());
  test->add(dal::TableDalTest::suite());
  test->add(dal::RasterDalTest::suite());
  test->add(dal::DataSourceTest::suite());
  test->add(dal::MemoryRasterDataTest::suite());
  test->add(dal::MemoryTableDataTest::suite());
  test->add(dal::MemoryDataPoolTest::suite());
  test->add(dal::MemoryRasterDriverTest::suite());
  test->add(dal::MemoryTableDriverTest::suite());

  // Mother of all tests: does dal do what we need.
  test->add(dal::UseCasesTest::suite());

  // lsof -p PID
  /*
  int result = runner.run(argc, argv);
  GDALDumpOpenDatasets(stderr);
  getchar();
  PRINT_VAR(result);
  return result;
  */

  return test;
}

